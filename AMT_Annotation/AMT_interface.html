<!-- You must include this JavaScript file -->
<script src="https://assets.crowd.aws/crowd-html-elements.js"></script>



<style>

button, .button_class0 {
  background-color: #4CAF50; /* Green */
  border: 1px solid green; /* Green border */
  color: white; /* White text */
  padding: 10px 6px; /* Some padding */
  cursor: pointer; /* Pointer/hand icon */
}


.button_class1 {
  background-color: #B22222; /* FireBrick */
  border: 1px solid #B22222; 
  color: white; /* text color */
  padding: 10px 6px; /* Some padding */
  cursor: pointer; /* Pointer/hand icon */
}
.button_class2 {
  background-color: #0000CD; /* MediumBlue */
  border: 1px solid #0000CD; 
  color: white; /* text color */
  padding: 10px 6px; /* Some padding */
  cursor: pointer; /* Pointer/hand icon */
}
.button_class3 {
  background-color: orange; 
  border: 1px solid orange; 
  color: white; /* text color */
  padding: 10px 6px; /* Some padding */
  cursor: pointer; /* Pointer/hand icon */
}

.button_class4 {
  background-color: olive; 
  border: 1px solid olive; 
  color: white; /* text color */
  padding: 10px 6px; /* Some padding */
  cursor: pointer; /* Pointer/hand icon */
}

.button_class5 {
  background-color: purple; 
  border: 1px solid purple; 
  color: white; /* text color */
  padding: 10px 6px; /* Some padding */
  cursor: pointer; /* Pointer/hand icon */
}

.button_class6 {
  background-color: maroon; 
  border: 1px solid maroon; 
  color: white; /* text color */
  padding: 10px 6px; /* Some padding */
  cursor: pointer; /* Pointer/hand icon */
}

.button_class7 {
  background-color: teal; 
  border: 1px solid teal; 
  color: white; /* text color */
  padding: 10px 6px; /* Some padding */
  cursor: pointer; /* Pointer/hand icon */
}

.button_class8 {
  background-color: #FF1493; /* deep pink */
  border: 1px solid #FF1493; 
  color: white; /* text color */
  padding: 10px 6px; /* Some padding */
  cursor: pointer; /* Pointer/hand icon */
}

.button_class9 {
  background-color: #2F4F4F;  /* DarkSlateGray */
  border: 1px solid #2F4F4F; 
  color: white; /* text color */
  padding: 10px 6px; /* Some padding */
  cursor: pointer; /* Pointer/hand icon */
}

.button_class10 {
  background-color: aqua; 
  border: 1px solid aqua; 
  color: black; /* text color */
  padding: 10px 6px; /* Some padding */
  cursor: pointer; /* Pointer/hand icon */
}

.button_class11 {
  background-color: #FFE4E1; /* MistyRose */
  border: 1px solid #FFE4E1; 
  color: black; /* text color */
  padding: 10px 6px; /* Some padding */
  cursor: pointer; /* Pointer/hand icon */
}

.button_class12 {
  background-color: yellow; 
  border: 1px solid yellow; 
  color: black; /* text color */
  padding: 10px 6px; /* Some padding */
  cursor: pointer; /* Pointer/hand icon */
}

.button_class13 {
  background-color: #EE82EE;  /* violet */
  border: 1px solid #EE82EE; 
  color: black; /* text color */
  padding: 10px 6px; /* Some padding */
  cursor: pointer; /* Pointer/hand icon */
}

.button_class14 {
  background-color: #90EE90;  /* LightGreen */
  border: 1px solid #90EE90; 
  color: black; /* text color */
  padding: 10px 6px; /* Some padding */
  cursor: pointer; /* Pointer/hand icon */
}

.button_class15 {
  background-color: #B0C4DE;  /* LightSteelBlue */
  border: 1px solid #B0C4DE; 
  color: black; /* text color */
  padding: 10px 6px; /* Some padding */
  cursor: pointer; /* Pointer/hand icon */
}

button:hover, .button_class0:hover, .button_class1:hover, .button_class2:hover, .button_class3:hover, .button_class4:hover, .button_class5:hover, .button_class6:hover, .button_class7:hover, 
.button_class8:hover, .button_class9:hover, .button_class10:hover, .button_class11:hover, .button_class12:hover, .button_class13:hover, .button_class14:hover, .button_class15:hover {
  filter: brightness(120%);
}

.image_div {
    /* height: 50%; */
}

.flex-container {
  display: flex;
  justify-content: center;
  align-items: center;
}

img {
    display: block;
    margin: auto;
    max-width: 100%;
    max-height: 100%;
}

.center {
    text-align:center;
    margin:auto;
}

.button_support {
    background-color: #333;
    border: 1px solid #333;
    color: #f2f2f2;
    padding: 6px 16px; /* Some padding */
    cursor: pointer; /* Pointer/hand icon */
}

.button_support:hover {
    background-color: #ddd;
    color: black;
}

/* Style the top navigation bar */
.topnav {
  overflow: hidden;
  background-color: #333; 
  position: fixed;  /* Always float on top of screen */
  width: 100%;
}

/* Style the topnav links */
.topnav a {
  float: left;
  display: block;
  color: #f2f2f2;
  text-align: center;
  padding: 10px 16px;
  text-decoration: none;
  font-size: 18;
}

/* Change color on hover */
.topnav a:hover {
  background-color: #ddd;
  color: #333;  
}

.blank_line {
    height: 12px;
    background-color: white;
}

/* The setting for collapsile item*/
.collapsible {
  /*background-color: #777;*/
  color: white;
  cursor: pointer;
  padding: 18px;
  width: 100%;
  border: none;
  text-align: left;
  outline: none;
  font-size: 15px;
}

.active, .collapsible:hover {
  filter: brightness(120%);
}

.content {
  padding: 0 18px;
  display: block;  /* initial state. 'none' to hide */
  overflow: hidden;
  background-color: #f1f1f1;
}

</style>


<div class="topnav">
  <a href="https://s3-ap-northeast-1.amazonaws.com/en-fr-translation-match/tutorial/tutorial.html" target="_blank">Tutorial</a>
  <a href="https://en-fr-translation-match.s3-ap-northeast-1.amazonaws.com/tutorial/ambiguous-case.html"target="_blank">Ambiguous cases explained</a>
</div>

<div style="height: 44px; background-color: white;"></div>
<button class="collapsible", style="background-color: Coral; font-size: 18px;" id="quick-start">Quick Start</button>
<div class="content">
  <p>In this mission, you are invited to match object phrases between English and its French translation. <br>
  The objects to mark are highlighted by different colors in the English sentence. <br>
  Your mission is to find the words in French for each of these highlighted English nominal phrases, by rendering them in the same color. <br>
  To render a word in French, please first click on a corresponding English word to choose the color, and then click corresponding French words one by one. <br>
  The green color means ordinary words. You do not need to act on words with green background in the English sentence. <br>
  When there is ambiguous translation, please <font color='green'>keep French phrase consistent with image</font> (i.e., please make sure that the French you highlight correctly describes the corresponding object in image). <br>
  Please look at <a href="https://en-fr-translation-match.s3-ap-northeast-1.amazonaws.com/tutorial/tutorial.html"target="_blank">illustrated tutorial</a> and <a href="https://en-fr-translation-match.s3-ap-northeast-1.amazonaws.com/tutorial/ambiguous-case.html"target="_blank">Ambiguous cases explained</a> for more information and illustration.
  </p>
</div>

<script>
// This part of javascript is to implement the collapsible item
var coll = document.getElementsByClassName("collapsible");
var i;
for (i = 0; i < coll.length; i++) {
  coll[i].addEventListener("click", function() {
    this.classList.toggle("active");
    var content = this.nextElementSibling;
    if (content.style.display === "block") {
      content.style.display = "none";
    } else {
      content.style.display = "block";
    }
  });
}
//document.getElementById("quick-start").nextElementSibling.style.display = "block";  // Set the initial state as expanded
// The statement above works, But only on IE8 or later. 

</script>
<!--
<div class="image_div">
    <img id="the-image", alt="The corresponding Flickr 30k image"></image>
</div>
<div class="blank_line"></div>
<div id="buttons-en" class="center">
  <button>En word</button>
  <button>En word</button>
  <button>En word</button>
</div>
<div class="blank_line"></div>
<div id="buttons-fr" class="center">
  <button>Fr word</button>
  <button>Fr word</button>
  <button>Fr word</button>
</div>




<crowd-form onsubmit="return tm.prepare_submit()" class="center">
    <textarea id="output-string" rows="4" cols="50" name="description">This text area will show the final string to be stored.</textarea>
    <crowd-input type="submit" value="Submit">
</crowd-form>
-->

<!-- <button onclick=test()>test</button>  -->

<script>
//var en = "[/EN#568/people A group of men] are loading [/EN#569/other cotton] onto [/EN#570/vehicles a truck]";
//en = "[/EN#1389/people A lady] in [/EN#1392/clothing a red coat] , holding [/EN#1390/clothing a bluish hand bag] likely of [/EN#1389/scene asian descent] , jumping off [/EN#0/notvisual the ground] for [/EN#1394/other a snapshot] ."
//var en = "[/EN#98260/people Two hussars] sit perched on [/EN#98261/animals horses] , dressed in [/EN#98260/other extravagant ceremonial wear] , [/EN#98260/other each] holding [/EN#98263/other a sabre] in [/EN#98264/bodyparts their right hand] , reigns to [/EN#98261/animals the horse] in [/EN#98272/scene their left] ."

//var fr = "Un groupe d'hommes chargent du coton dans un camion";
//var fr = "Une femme en manteau rouge, avec un sac à main bleuté probablement d'origine asiatique, sautant en l'air pour une photo."
//var fr = "Deux hussards sont juchés sur des chevaux, vêtus de tenues de cérémonie extravagantes, chacun tenant un sabre dans leur main droite, les rênes sur leur gauche."

//var img_name = "1054620089.jpg";
//var img_name = "317386541.jpg";
//var img_path = "http://ec2-54-168-88-201.ap-northeast-1.compute.amazonaws.com/flickr30k-images/" + img_name;


/*
var ens = [];
ens.push("val**000**e**[/EN#98260/people Two hussars] sit perched on [/EN#98261/animals horses] , dressed in [/EN#98260/other extravagant ceremonial wear] , [/EN#98260/other each] holding [/EN#98263/other a sabre] in [/EN#98264/bodyparts their right hand] , reigns to [/EN#98261/animals the horse] in [/EN#98272/scene their left] .");
ens.push("val**001**e**[/EN#568/people A group of men] are loading [/EN#569/other cotton] onto [/EN#570/vehicles a truck]");
ens.push("val**002**e**[/EN#1389/people A lady] in [/EN#1392/clothing a red coat] , holding [/EN#1390/clothing a bluish hand bag] likely of [/EN#1389/scene asian descent] , jumping off [/EN#0/notvisual the ground] for [/EN#1394/other a snapshot] .");
var frs = [];
frs.push("val**000**e**Deux hussards sont juchés sur des chevaux, vêtus de tenues de cérémonie extravagantes, chacun tenant un sabre dans leur main droite, les rênes sur leur gauche.");
frs.push("val**001**e**Un groupe d'hommes chargent du coton dans un camion");
frs.push("val**002**e**Une femme en manteau rouge, avec un sac à main bleuté probablement d'origine asiatique, sautant en l'air pour une photo.");
var img_names = [];
img_names.push("val**000**e**317386541.jpg");
img_names.push("val**001**e**1018148011.jpg");
img_names.push("val**002**e**1054620089.jpg");
var question_prefixes = []; // For each question, the prefix for ens, frs, img_names should be the same
*/

var ens = [];
var frs = [];
var img_names = [];
var question_prefixes = []; // For each question, the prefix for ens, frs, img_names should be the same

ens.push("${En0}");
ens.push("${En1}");
ens.push("${En2}");
ens.push("${En3}");
ens.push("${En4}");
ens.push("${En5}");
ens.push("${En6}");
ens.push("${En7}");
ens.push("${En8}");
ens.push("${En9}");
ens.push("${control_En0}");
ens.push("${control_En1}");
frs.push("${Fr0}");
frs.push("${Fr1}");
frs.push("${Fr2}");
frs.push("${Fr3}");
frs.push("${Fr4}");
frs.push("${Fr5}");
frs.push("${Fr6}");
frs.push("${Fr7}");
frs.push("${Fr8}");
frs.push("${Fr9}");
frs.push("${control_Fr0}");
frs.push("${control_Fr1}");
img_names.push("${ImageName0}");
img_names.push("${ImageName1}");
img_names.push("${ImageName2}");
img_names.push("${ImageName3}");
img_names.push("${ImageName4}");
img_names.push("${ImageName5}");
img_names.push("${ImageName6}");
img_names.push("${ImageName7}");
img_names.push("${ImageName8}");
img_names.push("${ImageName9}");
img_names.push("${control_ImageName0}");
img_names.push("${control_ImageName1}");





// prefix example: val**50**e**original_string
for(let i=0; i<img_names.length;i++) {
    let temp = ens[i].lastIndexOf("**");
    question_prefixes.push(ens[i].slice(0, temp));   
    
    ens[i] = ens[i].split("**")[3];
    frs[i] = frs[i].split("**")[3];
    img_names[i] = img_names[i].split("**")[3];
    
}





</script>



<script>

class TranslationMatchingBlock {
    
    constructor(annotated_sentence, unannotated_sentence, image_name, message_array, question_prefix, position_before_randomization) {
        
        this.instance_num = TranslationMatchingBlock.getInstanceCounter();
        this.name_of_this_instance = 'tmbs[' + this.instance_num + ']';
        this.message_array = message_array;
        this.state_chosen = 0; // State 0 means not clicked, 1, 2, 3, ... means the pairing information with English sentence.
        this.source_word_clicked = -1;
        this.object_total_number = 0;
        this.position_before_randomization = position_before_randomization;
        
        this.question_prefix = question_prefix; // question_prefix example: val**9**e
        //let temp = ens[i].lastIndexOf("**");
        //this.query_id = question_prefix.slice(0, temp);  // query_id example: val**9
        
        this.image_name = image_name;
        //this.image_root_path = "http://ec2-54-168-88-201.ap-northeast-1.compute.amazonaws.com/flickr30k-images/";
        this.image_root_path = "https://flickr30k-data.s3-ap-northeast-1.amazonaws.com/flickr30k-images/";
        this.image_path = this.image_root_path + this.image_name;
        
        //this.displayMessage("function called")
        
        this.words_annotated = this.parceAnnotatedSentence(annotated_sentence);
        this.words_unannotated = this.parceUnannotatedSentence(unannotated_sentence);
        
        this.addHTMLBlock();
        //document.getElementById('buttons-en').innerHTML = this.changeButtonGroupContent(this.words_annotated, "EN");
        this.renderButtonsForAnnotatedSentence(this.words_annotated, "EN");
       
        //document.getElementById('buttons-fr').innerHTML = this.changeButtonGroupContent(this.words_unannotated, "FR");
        
        this.initButtonStateForUnannotatedSentence();
        
        this.out = undefined;
        
        
        
        TranslationMatchingBlock.increaseInstanceCounter();
    }
    
    addHTMLBlock() {
        
        document.write("<p>Question No." + (this.instance_num+1) + "</p>"); // Noted that only in the user interface the number begins by 1. In all other places the number begins by 0. 
        document.write("<div class='image_div'> \
                            <img id='image" + this.instance_num + "' alt='The corresponding Flickr 30k image'></image>   \
                        </div>");
        document.getElementById('image' + this.instance_num).src = this.image_path; 
        //document.getElementById('image0').src = "http://ec2-54-168-88-201.ap-northeast-1.compute.amazonaws.com/flickr30k-images/317386541.jpg"
        document.write("<div class='blank_line'></div>");
        document.write("<div id='buttons-en" + this.instance_num + "' class='center'>" + this.changeButtonGroupContent(this.words_annotated, 'EN') + "</div>");
        document.write("<div class='blank_line'></div>");
        document.write("<div id='buttons-fr" + this.instance_num + "' class='center'>" + this.changeButtonGroupContent(this.words_unannotated, 'FR') + "</div>");
        document.write("<div class='blank_line'></div>");
        document.write("<div class='blank_line'></div>");
    }
    
    static increaseInstanceCounter() {
        TranslationMatchingBlock._instance_counter++;
    }
    
    static getInstanceCounter() {
        return TranslationMatchingBlock._instance_counter;
    }
    
    //function changeButtonGroupContent(name_list, button_id_prefix, para_dict_name) {
    changeButtonGroupContent(name_list, button_id_prefix) {
    	// name_list is expected to be an array of strings
        var buttons = "";
        var i = 0;
        //button id format eg: 3EN2  -- the 2nd English word in the 3rd question within the HIT 
        for (i=0; i<name_list.length; i++) {
        	var str_id = " id='" + this.instance_num + button_id_prefix + i + "' ";
            //var str_onclick = " onclick='clickOn" + button_id_prefix + "(this.id," + para_dict_name + ")' ";
            var str_onclick = " onclick='" + this.name_of_this_instance + ".clickOn" + button_id_prefix + "(this.id)' ";
        	var button = "<button " + str_id + str_onclick + " >" + name_list[i] + "</button>";
            buttons += button;
        }
    	return buttons
    
    }
    
    //function clickOnFR(btn_id, para_dict) // Note that if button_id_prefix is not FR, this function name need to be changed accordingly
    clickOnFR(btn_id) // Note that if button_id_prefix is not FR, this function name need to be changed accordingly
    {
    	var this_btn = document.getElementById(btn_id);
        //var old_state = this_btn.click_state;
        if(this_btn.click_state != this.state_chosen) {
            this_btn.click_state = this.state_chosen;
            this_btn.setAttribute("class", "button_class"+this_btn.click_state);
        }
        else {
            this_btn.click_state = 0;
            this_btn.setAttribute("class", "button_class"+this_btn.click_state);
        }
        
        /*
        if(this_btn.click_state == 0) {
        	this_btn.click_state = para_dict.state_chosen; 
        	//this_btn.click_state = state_chosen; 
            this_btn.setAttribute("class", "button_class"+this_btn.click_state);
        }
        else if (this_btn.click_state > 0) {
        	this_btn.click_state = 0;
            this_btn.setAttribute("class", "button_class"+this_btn.click_state);
        }
        else ;
        */
        //alert("this_btn.state:"+old_state+"-->"+this_btn.click_state);
      	//alert("btnid:" + btn_id)
    }
    
    //function clickOnEN(btn_id, para_dict) // Note that if button_id_prefix is not EN, this function name need to be changed accordingly
    clickOnEN(btn_id) // Note that if button_id_prefix is not EN, this function name need to be changed accordingly
    {
        var this_btn = document.getElementById(btn_id);
        //para_dict.state_chosen = this_btn.object_num;
        this.state_chosen = this_btn.object_num;
        
        // Diminish the last button clicked
        if(this.source_word_clicked != -1) {
            document.getElementById(this.instance_num+"EN"+this.source_word_clicked).style.padding = "10px 6px";
        }
        
        // Enlarge the current button clicked
        this_btn.style.padding = "14px 10px";
        
        //Due to: 1EN2 vs 10EN2, to parse the button number within one sentence (the latter number), first we need to locate latin letter
        var idx = btn_id.search(/[A-Za-z][A-Za-z]/);
        this.source_word_clicked = parseInt(btn_id.slice(idx+2)); //The language prefix has to be 2 characters. Then this function could slice from the correct position.
        //alert("click on en: " + chosen_state)
    }
    
    parceUnannotatedSentence(unannotated_sentence) {
        if(false) {  // Set here to true when unannotated_sentence is from multi30k/.../raw/val.fr . When sentences come from .../tok/val.lc.norm.tok.fr, it is not needed to do following three lines. 
            unannotated_sentence = unannotated_sentence.trim();
            unannotated_sentence = unannotated_sentence.replace(/,/g, " ,"); // Add a space in front of comma
            unannotated_sentence = unannotated_sentence.replace(/\./g, " ."); // Add a space in front of period
        }
        return unannotated_sentence.split(" ");
    }
    
    initButtonStateForUnannotatedSentence() {
        for(var i = 0; i<this.words_unannotated.length; i++) {
        	var btn = document.getElementById(this.instance_num+"FR"+i);
        	btn.click_state = 0;
            btn.num = i;
            btn.word = this.words_unannotated[i];
        }
    }
    
    parceAnnotatedSentence(annotated_sentence) {
        annotated_sentence = annotated_sentence.replace(/\[/g, "zzzLEFTzzz");
        annotated_sentence = annotated_sentence.replace(/\]/g, "][");
        annotated_sentence = annotated_sentence.replace(/zzzLEFTzzz/g,"][");
        annotated_sentence = "[" + annotated_sentence;
        annotated_sentence = annotated_sentence + "]";
      
        var words_annotated = annotated_sentence.match(/\[(.*?)\]/g)
      
        for (var i=0; i<words_annotated.length;i++) {
      	    words_annotated[i] = words_annotated[i].slice(1,-1);
            words_annotated[i] = words_annotated[i].trim();
        }
      
        words_annotated = words_annotated.filter(function(str){return str.length>0;});
      
        //alert(annotated_sentence +"\n" + words_annotated);
        return words_annotated
    }
    
    renderButtonsForAnnotatedSentence(words_annotated, button_id_prefix) {
        var object_counter = 0;
        for(var i = 0; i<words_annotated.length; i++) {
        	var btn = document.getElementById(this.instance_num+button_id_prefix+i); // button_id_prefix is a string, making the sum a string.
        	var first_space_index;
        	
        	if(words_annotated[i][0]=='/') {    // An annotated object
        	    first_space_index = words_annotated[i].search(" ");
        	    btn.object_str = words_annotated[i].slice(0,first_space_index);
        	    btn.word = words_annotated[i].slice(first_space_index+1);
        	    object_counter += 1;
        	    btn.object_num = object_counter;
        	    this.object_total_number = object_counter;
        	}
        	else {  // Ordinary word
        	    btn.object_str = "";
        	    btn.word = words_annotated[i];
        	    btn.object_num = 0;
        	}
        	
            btn.num = i;
            
            btn.innerHTML = btn.word;
            
            btn.setAttribute("class", "button_class"+btn.object_num);
        }
    }
    
    get_btn_id_by_state_num(state_number, source_prefix) {
        var i = 0;
        var btn_source;
        while(btn_source = document.getElementById(this.instance_num+source_prefix+i)) {
            if(btn_source.object_num ==state_number) {
                return i;
            }
            
            i++;
        }
        alert("Some error occurs in get_btn_id_by_state_num...");
        return -1;
    }
    
    writeToString(source_prefix, target_prefix) {
        var str = "";
        var temp = 0;
        var idx;
        for(var i=0; i<this.words_unannotated.length; i++) {
            var btn_target = document.getElementById(this.instance_num+target_prefix+i);
            if(btn_target.click_state > 0 && btn_target.click_state != temp) {
                idx = this.get_btn_id_by_state_num(btn_target.click_state, "EN");
                var btn_source = document.getElementById(this.instance_num+source_prefix+idx);
                str = str + " [" + btn_source.object_str + " " + btn_target.word;
            }
            else if(btn_target.click_state > 0 && btn_target.click_state == temp) {
                str = str + " " + btn_target.word;
            }
            else if(btn_target.click_state != temp && temp == 0) {
                str = str + "] " + btn_target.word;
            }
            else if(btn_target.click_state != temp && temp > 0 && btn_target.click_state > 0) {
                str = str + "] ";
                idx = this.get_btn_id_by_state_num(btn_target.click_state, "EN")
                var btn_source = document.getElementById(this.instance_num+source_prefix+idx);
                str = str + " [" + btn_source.object_str + " " + btn_target.word;
            }
            else if(btn_target.click_state == 0 && temp > 0) {
                str = str + "] " + btn_target.word;
                
            }
            else if(btn_target.click_state == 0 && temp == 0) {
                str = str + " " + btn_target.word;
            }
            else {
                alert("Well, some problem happens in the function writeToString...")
            }
            temp = btn_target.click_state;
        }
        if(temp != 0){
            str = str + "]";
        }
        return this.question_prefix + "**" + str; // Finally we add the prefix back at the beginning of the sentence
    }
    
    check_states_clicked(target_prefix) {
        var states_clicked_set = new Set();
        
        for(var i=0; i<this.words_unannotated.length; i++) {
            var btn_target = document.getElementById(this.instance_num+target_prefix+i);
            if(btn_target.click_state != 0)
                states_clicked_set.add(btn_target.click_state);
        }
        //console.log(states_clicked_set.size)
        if(states_clicked_set.size < this.object_total_number) {
            this.message_array.push("In question No." + (this.instance_num+1) + ", the original sentence has " + this.object_total_number + " entities, while you only marked " + states_clicked_set.size + " entity(ies) in the new sentence.");
            return false;
        }
        else {
            return true;
        }
            
    }
    
    check_states_consecutive(target_prefix)   // target_prefix suppose to be 'FR'
    {
        var state_clicked_and_ended_set = new Set();  // This set contains the state that has been clicked and also ended('ended' means a different state has been chosen)
        
        var last_state = undefined;
      
        for(var i=0; i<this.words_unannotated.length; i++) {
            var btn_target = document.getElementById(this.instance_num+target_prefix+i);

            if(btn_target.click_state != 0)  {  // If current state is not green. (Green state is a trivial state, and it could be repeated.)
                if(state_clicked_and_ended_set.has(btn_target.click_state))  {  // Current state is repeated
                    // console.log("i="+i+",state="+btn_target.click_state+",set="+[...state_clicked_and_ended_set].join(' '));
                    return false;
                }
                
            }
            if(btn_target.click_state != last_state && last_state != undefined) { // Current state is different with the last state, so the last state should be forbidden to appear again in the future
                state_clicked_and_ended_set.add(last_state);
            }
            last_state = btn_target.click_state
        }
        return true;
    }
    
    displayMessage(str) {
        alert(str)
    }

} // End of class definition

function displayDescription() {
    alert("Please match the English-French translation pairs in the given sentences.\nHow to do this?\nFirst, click on a colored phrase (i.e. a phrase not in green color) in the English sentence.\nSecond, click on the corresponding word or words in the French sentence to make them in the same color as in English. \nDo this for all colored phrases in English. \nClick submit button.")
}

function shuffle(arra1) //This function is borrowed from https://www.w3resource.com/javascript-exercises/javascript-array-exercise-17.php
{
    var ctr = arra1.length, temp, index;

    // While there are elements in the array
    while (ctr > 0) {
    // Pick a random index
        index = Math.floor(Math.random() * ctr);
    // Decrease ctr by 1
        ctr--;
    // And swap the last element with it
        temp = arra1[ctr];
        arra1[ctr] = arra1[index];
        arra1[index] = temp;
    }
    return arra1;
}

TranslationMatchingBlock._instance_counter = 0; // begin with 0
var checking_messages = [];

var tmbs = [];  // Array of TranslationMatchingBlock
//tmbs.push(new TranslationMatchingBlock(en, fr, "317386541.jpg", checking_messages));
/*
for(var j=0; j<img_names.length; j++) {
    tmbs.push(new TranslationMatchingBlock(ens[j], frs[j], img_names[j], checking_messages, question_prefixes[j]));
}
*/
idx_list = [];
for(let i=0; i<img_names.length; i++) {
    idx_list.push(i);
}
if(true) {  // Set here to true to shuffle
    idx_list = shuffle(idx_list);  // Shuffle the order of blocking block
}
for(let i=0; i<img_names.length; i++) {
    let idx = idx_list[i];
    tmbs.push(new TranslationMatchingBlock(ens[idx], frs[idx], img_names[idx], checking_messages, question_prefixes[idx], idx));
}



function multi_textarea_html_string() {
    str = "";
    for(var i=0; i<TranslationMatchingBlock.getInstanceCounter(); i++) {
        str = str + " <textarea id='output-string" + i + "' rows='4' cols='50' name='description" + tmbs[i].position_before_randomization + "'>This text area will show the final string to be stored.</textarea> "; // description + tmbs[i].position_before_randomization is for reconstructing the questions in same order as in input file after submission. .
    }
    return str;
}

function writeAllResponsesToTextarea() {
    for(var i=0; i<tmbs.length; i++) {
        document.getElementById('output-string'+i).innerHTML = tmbs[i].writeToString("EN", "FR");
    }
}

function prepare_submit() {
    for(var i=0; i<tmbs.length; i++) {
        
        if(!tmbs[i].check_states_consecutive("FR")) {  //if there is one answer which is unconsecutive
            alert("There is unconsecutive phrase in your response to the question No." + (i+1) + ". Please modify it so that the words belong to the same phrase are always consecutive. \n \
            Did you forget to change color when you click next phrase? \n  \
            Or, if the exact translation has to be unconsecutive, please choose a part of that exact translation.\n \
            When choosing only a part, please choose the part that is more fundamental.")
            return false;  //The answer is illegal, so go back directly. 
        }
    }
    
    var good_response = true;
    
    for(var i=0; i<tmbs.length; i++) {
        let temp = tmbs[i].check_states_clicked("FR")
        good_response = good_response && temp;
    }
    
    //console.log("good_response" + good_response)
    if(!good_response) {
        if(confirm(checking_messages.join("\n") + "\n\nAre you sure this is the final answer?\n\nPlease click Cancel to check your answers or click OK to submit anyway.\n")) {
            writeAllResponsesToTextarea(tmbs);
            checking_messages.length = 0; //Empty the message array
            return true;
        }
        checking_messages.length = 0; //Empty the message array
        return false;
    }
    writeAllResponsesToTextarea(tmbs);
    checking_messages.length = 0; //Empty the message array
    return true;
    
    //alert("Hey my friend, you are about to submit!")
}

document.write("<crowd-form onsubmit='return prepare_submit()' class='center'>  "
                     + multi_textarea_html_string() +
                    "<crowd-input type='submit' value='Submit'>  \
                </crowd-form>");


for(var i=0; i<TranslationMatchingBlock.getInstanceCounter(); i++) {
    document.getElementById('output-string'+i).hidden = true; 
}


</script>
<p><center> <font size=6>Thank you for your work ^-^</font></center></p>
<div class='blank_line'></div>
<img src="https://en-fr-translation-match.s3-ap-northeast-1.amazonaws.com/resources/ids+logo.png">

<!--
<style>
#confirm {
    display: none;
    background-color: #91FF00;
    border: 1px solid #aaa;
    position: fixed;
    width: 250px;
    left: 50%;
    margin-left: -100px;
    padding: 6px 8px 8px;
    box-sizing: border-box;
    text-align: center;
}
#confirm button {
    background-color: #48E5DA;
    display: inline-block;
    border-radius: 5px;
    border: 1px solid #aaa;
    padding: 5px;
    text-align: center;
    width: 80px;
    cursor: pointer;
}
#confirm .message {
    text-align: left;
}
</style>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>

<script>
function functionAlert(msg, myYes) {
    var confirmBox = $("#confirm");
    confirmBox.find(".message").text(msg);
    confirmBox.find(".yes").unbind().click(function() {
        confirmBox.hide();
    });
    confirmBox.find(".yes").click(myYes);
    confirmBox.show();
}
  
function yesfunc() {
	document.write("Oh yes");
}

function nofunc() {
	document.write("Oh no");
}
    
</script>

<div id="confirm">
    <div class="message">This is a warning message.</div>
    <button onclick="yesfunc()">Confirm matching</button>
    <button onclick="nofunc()">confirm current response</button>
</div>

<script>
functionAlert("message_array");
</script>


-->
<!--
<script>
function test() {
    alert(tm.object_total_number)
}
</script>
<button onclick="test()">test</button>


<input type = "button"  value = "Click Me"  onclick = "functionAlert();" />



<script>
alert("HTML loaded")
</script>
-->

